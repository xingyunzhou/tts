<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>üéôÔ∏è TTS ÊúçÂä°ÁªàÊûÅÊµãËØïÈ°µÈù¢ (v3.0 - EdgeOne PagesÁâà)</title>
  <style>
    :root {
      --primary-color: #4f46e5;
      --success-color: #22c55e;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --light-gray: #f8fafc;
      --gray: #64748b;
      --border-color: #e2e8f0;
      --text-color: #1e293b;
      --mint-start: #f0fdfa;
      --mint-middle: #e6fffa;
      --mint-end: #fdf2f8;
      --mint-accent: #6ee7b7;
    }

    * {
      box-sizing: border-box;
    }

    html {
      padding: 0;
      margin: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--mint-start) 0%, var(--mint-middle) 50%, var(--mint-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    [v-cloak] {
      display: none;
    }

    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem 0 2rem;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 2rem;
      font-weight: 700;
      font-size: 1.8rem;
      background: linear-gradient(135deg, var(--primary-color), var(--mint-accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      background-color: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .textarea-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .clear-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .clear-btn:hover {
      background-color: rgba(79, 70, 229, 0.1);
    }

    .label-with-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .pause-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pause-input {
      width: 6.5em;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
    }

    .pause-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .btn-insert-pause {
      background: linear-gradient(135deg, var(--mint-accent), #10b981);
      color: white;
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-insert-pause:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-insert-pause:active {
      transform: scale(0.95);
    }

    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-group input[type="range"] {
      flex-grow: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
    }

    .slider-group input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
    }

    .slider-group span {
      font-weight: 500;
      min-width: 50px;
      text-align: right;
      color: var(--primary-color);
      font-size: 0.9rem;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }

    button {
      padding: 0.9rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-generate {
      background: linear-gradient(135deg, var(--gray), #475569);
      color: white;
    }

    .btn-stream {
      background: linear-gradient(135deg, var(--success-color), #16a34a);
      color: white;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status-info {
      background-color: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #93c5fd;
    }

    .status-success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .status-error {
      background-color: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    audio {
      width: 100%;
      margin-top: 1.5rem;
      border-radius: 8px;
    }

    .download-section {
      margin-top: 1rem;
      text-align: center;
    }

    .btn-download {
      background: linear-gradient(135deg, var(--warning-color), #d97706);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-download:active {
      transform: scale(0.97);
    }

    details {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      background-color: rgba(248, 250, 252, 0.8);
    }

    summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--text-color);
      padding: 0.5rem 0;
    }

    summary:hover {
      color: var(--primary-color);
    }

    .checkbox-grid {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.8rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .app-container {
        padding: 0 0 1rem;
      }

      .container {
        padding: 1.5rem;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .grid-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .slider-group span {
        min-width: 45px;
        font-size: 0.85rem;
      }

      textarea {
        min-height: 100px;
      }

      .label-with-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .pause-controls {
        align-self: flex-end;
      }

      .pause-input {
        font-size: 0.85rem;
      }

      .btn-insert-pause {
        font-size: 0.8rem;
        padding: 0.35rem 0.7rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
        margin: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      input[type="text"],
      input[type="password"],
      select,
      textarea {
        padding: 0.7rem;
        font-size: 16px;
        /* Èò≤Ê≠¢iOSÁº©Êîæ */
      }

      .slider-group {
        gap: 0.5rem;
      }
    }

    /* Âä†ËΩΩÂä®Áîª */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="app" class="app-container">
    <main class="container">
      <h1 v-cloak>{{ title }}</h1>

      <details>
        <summary>API ÈÖçÁΩÆ</summary>
        <div class="form-group" style="margin-top: 1rem">
          <label for="baseUrl">API Base URL</label>
          <input type="text" id="baseUrl" v-model="config.baseUrl" @input="saveConfig" placeholder="https://‰Ω†ÁöÑÂüüÂêç" />
        </div>
        <div class="form-group" style="margin-bottom: 0">
          <label for="apiKey">API Key</label>
          <input type="password" id="apiKey" v-model="config.apiKey" @input="saveConfig" placeholder="hello" />
        </div>
      </details>

      <div class="form-group">
        <div class="label-with-controls">
          <label for="inputText">ËæìÂÖ•ÊñáÊú¨</label>
          <div class="pause-controls">
            <input type="number" v-model.number="pauseTime" min="0.01" max="100" step="0.01" placeholder="ÂÅúÈ°øÊó∂Èïø"
              class="pause-input" />
            <button type="button" @click="insertPause" class="btn-insert-pause" title="Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•ÂÅúÈ°ø">
              ÊèíÂÖ•ÂÅúÈ°ø
            </button>
          </div>
        </div>
        <textarea id="inputText" ref="textareaRef" v-model="form.inputText" @input="saveForm"
          placeholder="ËØ∑Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨ÔºåÁõÆÂâçÂ∞ΩÂèØËÉΩ‰∏çË¶ÅË∂ÖËøá1ÁÇπ5‰∏áÂ≠óÊØèÊ¨°Ôºå‰∏çÁÑ∂‰ºöÊä•Èîô„ÄÇÈü≥Ëâ≤Êò†Â∞ÑÂèØ‰ª•Ëá™Ë°å‰øÆÊîπEdgeOneÂáΩÊï∞ÁöÑÈÖçÁΩÆ"></textarea>
        <div class="textarea-footer">
          <span v-cloak>{{ charCount }} Â≠óÁ¨¶</span>
          <button class="clear-btn" @click="clearText">Ê∏ÖÈô§</button>
        </div>
      </div>

      <div class="grid-layout">
        <div class="form-group">
          <label for="voice">ÈÄâÊã©Èü≥Ëâ≤ (Model)</label>
          <select id="voice" v-model="form.voice" @change="saveForm">
            <option value="zh-CN-XiaoxiaoNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÊôì)</option>
            <option value="zh-CN-YunxiNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÂ∏å)</option>
            <option value="zh-CN-YunyangNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÊâ¨)</option>
            <option value="zh-CN-XiaoyiNeural">‰∏≠ÊñáÂ•≥Â£∞ (Êôì‰ºä)</option>
            <option value="zh-CN-YunjianNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÂÅ•)</option>
            <option value="zh-CN-XiaochenNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìËæ∞)</option>
            <option value="zh-CN-XiaohanNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÊ∂µ)</option>
            <option value="zh-CN-XiaomengNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÊ¢¶)</option>
            <option value="zh-CN-XiaomoNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÂ¢®)</option>
            <option value="zh-CN-XiaoqiuNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÁßã)</option>
            <option value="zh-CN-XiaoruiNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÁùø)</option>
            <option value="zh-CN-XiaoshuangNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÂèå)</option>
            <option value="zh-CN-XiaoxuanNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìËê±)</option>
            <option value="zh-CN-XiaoyanNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÈ¢ú)</option>
            <option value="zh-CN-XiaoyouNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÊÇ†)</option>
            <option value="zh-CN-XiaozhenNeural">‰∏≠ÊñáÂ•≥Â£∞ (ÊôìÁîÑ)</option>
            <option value="zh-CN-YunfengNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÊû´)</option>
            <option value="zh-CN-YunhaoNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÁöì)</option>
            <option value="zh-CN-YunxiaNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÂ§è)</option>
            <option value="zh-CN-YunyeNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÈáé)</option>
            <option value="zh-CN-YunzeNeural">‰∏≠ÊñáÁî∑Â£∞ (‰∫ëÊ≥Ω)</option>
            <option value="en-US-JennyNeural">Ëã±ÊñáÂ•≥Â£∞ (Jenny)</option>
            <option value="en-US-GuyNeural">Ëã±ÊñáÁî∑Â£∞ (Guy)</option>
            <option value="en-US-AriaNeural">Ëã±ÊñáÂ•≥Â£∞ (Aria)</option>
            <option value="en-US-DavisNeural">Ëã±ÊñáÁî∑Â£∞ (Davis)</option>
            <option value="en-US-AmberNeural">Ëã±ÊñáÂ•≥Â£∞ (Amber)</option>
            <option value="en-US-AnaNeural">Ëã±ÊñáÂ•≥Â£∞ (Ana)</option>
            <option value="en-US-AshleyNeural">Ëã±ÊñáÂ•≥Â£∞ (Ashley)</option>
            <option value="en-US-BrandonNeural">Ëã±ÊñáÁî∑Â£∞ (Brandon)</option>
            <option value="en-US-ChristopherNeural">Ëã±ÊñáÁî∑Â£∞ (Christopher)</option>
            <option value="en-US-CoraNeural">Ëã±ÊñáÂ•≥Â£∞ (Cora)</option>
            <option value="en-US-ElizabethNeural">Ëã±ÊñáÂ•≥Â£∞ (Elizabeth)</option>
            <option value="en-US-EricNeural">Ëã±ÊñáÁî∑Â£∞ (Eric)</option>
            <option value="en-US-JacobNeural">Ëã±ÊñáÁî∑Â£∞ (Jacob)</option>
            <option value="en-US-JaneNeural">Ëã±ÊñáÂ•≥Â£∞ (Jane)</option>
            <option value="en-US-JasonNeural">Ëã±ÊñáÁî∑Â£∞ (Jason)</option>
            <option value="en-US-MichelleNeural">Ëã±ÊñáÂ•≥Â£∞ (Michelle)</option>
            <option value="en-US-MonicaNeural">Ëã±ÊñáÂ•≥Â£∞ (Monica)</option>
            <option value="en-US-NancyNeural">Ëã±ÊñáÂ•≥Â£∞ (Nancy)</option>
            <option value="en-US-RogerNeural">Ëã±ÊñáÁî∑Â£∞ (Roger)</option>
            <option value="en-US-SaraNeural">Ëã±ÊñáÂ•≥Â£∞ (Sara)</option>
            <option value="en-US-SteffanNeural">Ëã±ÊñáÁî∑Â£∞ (Steffan)</option>
            <option value="en-US-TonyNeural">Ëã±ÊñáÁî∑Â£∞ (Tony)</option>
          </select>
        </div>
        <div class="form-group">
          <label>ËØ≠ÈÄü</label>
          <div class="slider-group">
            <input type="range" v-model.number="form.speed" @input="saveForm" min="0.25" max="2.0" step="0.05" />
            <span v-cloak>{{ speedDisplay }}</span>
          </div>
        </div>
        <div class="form-group">
          <label>Èü≥Ë∞É</label>
          <div class="slider-group">
            <input type="range" v-model.number="form.pitch" @input="saveForm" min="0.5" max="1.5" step="0.05" />
            <span v-cloak>{{ pitchDisplay }}</span>
          </div>
        </div>
      </div>

      <details>
        <summary>È´òÁ∫ßÊñáÊú¨Ê∏ÖÁêÜÈÄâÈ°π</summary>
        <div class="checkbox-grid">
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeMarkdown" @change="saveForm" />
            ÁßªÈô§ Markdown
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeEmoji" @change="saveForm" />
            ÁßªÈô§ Emoji
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeUrls" @change="saveForm" />
            ÁßªÈô§ URL
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeLineBreaks" @change="saveForm" />
            ÁßªÈô§ÊâÄÊúâÁ©∫ÁôΩ/Êç¢Ë°å
          </label>
          <label class="checkbox-item">
            <input type="checkbox" v-model="form.cleaning.removeCitation" @change="saveForm" />
            ÁßªÈô§ÂºïÁî®Ê†áËÆ∞Êï∞Â≠ó
          </label>
        </div>
        <div class="form-group" style="margin-top: 1rem; margin-bottom: 0">
          <label for="customKeywords">Ëá™ÂÆö‰πâÁßªÈô§ÂÖ≥ÈîÆËØç (ÈÄóÂè∑ÂàÜÈöî)</label>
          <input type="text" id="customKeywords" v-model="form.cleaning.customKeywords" @input="saveForm"
            placeholder="‰æãÂ¶Ç: ABC,XYZ" />
        </div>
      </details>

      <div class="button-group">
        <button class="btn-generate" v-cloak :disabled="isLoading" @click="generateSpeech(false)">
          <span v-if="isLoading && !isStreaming" class="loading"></span>
          {{ isLoading && !isStreaming ? 'ÁîüÊàê‰∏≠...' : 'ÁîüÊàêËØ≠Èü≥ (Ê†áÂáÜ)' }}
        </button>
        <button class="btn-stream" v-cloak :disabled="isLoading" @click="generateSpeech(true)">
          <span v-if="isLoading && isStreaming" class="loading"></span>
          {{ isLoading && isStreaming ? 'ÊµÅÂºèÊí≠Êîæ‰∏≠...' : 'ÁîüÊàêËØ≠Èü≥ (ÊµÅÂºè)' }}
        </button>
      </div>

      <div class="status" :class="['status-' + status.type, { show: status.show }]" v-cloak>
        {{ status.message }}
      </div>

      <audio ref="audioPlayer" controls v-show="audioSrc" v-cloak :src="audioSrc" @loadstart="onAudioLoadStart"
        @canplay="onAudioCanPlay"></audio>

      <!-- ‰∏ãËΩΩÊåâÈíÆ -->
      <div v-if="showDownloadBtn" class="download-section" v-cloak>
        <button class="btn-download" @click="downloadAudio">
          <span>üì•</span> ‰∏ãËΩΩÈü≥È¢ëÊñá‰ª∂
        </button>
      </div>
    </main>
  </div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          title: 'TTS ÊúçÂä°ÁªàÊûÅÊµãËØïÈ°µÈù¢ (v3.0 - EdgeOne PagesÁâà)',
          isLoading: false,
          isStreaming: false,
          audioSrc: '',
          downloadUrl: '', // Ê∑ªÂä†‰∏ãËΩΩÈìæÊé•
          showDownloadBtn: false, // ÊéßÂà∂‰∏ãËΩΩÊåâÈíÆÊòæÁ§∫
          pauseTime: 1.0, // ÂÅúÈ°øÊó∂Èó¥
          config: {
            baseUrl: window.location.origin,
            apiKey: 'hello'
          },
          form: {
            inputText: 'ËØ∑Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨ÔºåÁõÆÂâçÂ∞ΩÂèØËÉΩ‰∏çË¶ÅË∂ÖËøá1ÁÇπ5‰∏áÂ≠óÊØèÊ¨°Ôºå‰∏çÁÑ∂‰ºöÊä•Èîô„ÄÇÈü≥Ëâ≤Êò†Â∞ÑÂèØ‰ª•Ëá™Ë°å‰øÆÊîπEdgeOneÂáΩÊï∞ÁöÑÈÖçÁΩÆ',
            voice: 'zh-CN-XiaoxiaoNeural',
            speed: 1.0,
            pitch: 1.0,
            cleaning: {
              removeMarkdown: true,
              removeEmoji: true,
              removeUrls: true,
              removeLineBreaks: true,
              removeCitation: true,
              customKeywords: ''
            }
          },
          status: {
            show: false,
            message: '',
            type: 'info'
          }
        }
      },
      computed: {
        charCount() {
          return this.form.inputText.length;
        },
        speedDisplay() {
          return this.form.speed.toFixed(2);
        },
        pitchDisplay() {
          return this.form.pitch.toFixed(2);
        }
      },
      methods: {
        loadConfig() {
          try {
            const saved = localStorage.getItem('tts_config');
            if (saved) {
              this.config = { ...this.config, ...JSON.parse(saved) };
              if (this.config.baseUrl.endsWith('/')) {
                this.config.baseUrl = this.config.baseUrl.slice(0, -1); // ÂéªÈô§Êú´Â∞æÁöÑÊñúÊù†
              }
            }
          } catch (e) {
            console.warn('Failed to load config from localStorage:', e);
          }
        },
        saveConfig() {
          try {
            localStorage.setItem('tts_config', JSON.stringify(this.config));
          } catch (e) {
            console.warn('Failed to save config to localStorage:', e);
          }
        },
        loadForm() {
          try {
            const saved = localStorage.getItem('tts_form');
            if (saved) {
              this.form = { ...this.form, ...JSON.parse(saved) };
            }
          } catch (e) {
            console.warn('Failed to load form from localStorage:', e);
          }
        },
        saveForm() {
          try {
            localStorage.setItem('tts_form', JSON.stringify(this.form));
          } catch (e) {
            console.warn('Failed to save form to localStorage:', e);
          }
        },
        clearText() {
          this.form.inputText = '';
          this.saveForm();
        },
        downloadAudio() {
          if (this.downloadUrl) {
            const link = document.createElement('a');
            link.href = this.downloadUrl;
            let timeString = (new Date().toLocaleString() + '-').replace(/[\/\:]/g, '-').replace(/\s/g, '_').replace(/[-_](\d)[-_]/g, '-0$1-').slice(0, -1);
            link.download = 'tts-audio-' + timeString + '.mp3';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        },
        updateStatus(message, type = 'info') {
          this.status = {
            show: true,
            message,
            type
          };
        },
        hideStatus() {
          this.status.show = false;
        },
        getRequestBody() {
          return {
            voice: this.form.voice,
            input: this.form.inputText.trim(),
            speed: this.form.speed,
            pitch: this.form.pitch,
            cleaning_options: {
              remove_markdown: this.form.cleaning.removeMarkdown,
              remove_emoji: this.form.cleaning.removeEmoji,
              remove_urls: this.form.cleaning.removeUrls,
              remove_line_breaks: this.form.cleaning.removeLineBreaks,
              remove_citation_numbers: this.form.cleaning.removeCitation,
              custom_keywords: this.form.cleaning.customKeywords,
            },
          };
        },
        async generateSpeech(isStream) {
          const baseUrl = this.config.baseUrl.trim(); // ÂéªÈô§Êú´Â∞æÁöÑÊñúÊù†
          const apiKey = this.config.apiKey.trim();
          const text = this.form.inputText.trim();

          if (!baseUrl || !apiKey || !text) {
            this.updateStatus('ËØ∑Â°´ÂÜô API ÈÖçÁΩÆÂíåËæìÂÖ•ÊñáÊú¨', 'error');
            return;
          }

          // È™åËØÅ API Key ÊòØÂê¶ÂåÖÂê´Èùû ASCII Â≠óÁ¨¶
          try {
            // ÊµãËØï API Key ÊòØÂê¶ÂèØ‰ª•ÂÆâÂÖ®Âú∞Áî®‰∫é HTTP Â§¥
            new Headers({ 'Authorization': 'Bearer ' + apiKey });
          } catch (e) {
            this.updateStatus('API Key ÂåÖÂê´Êó†ÊïàÂ≠óÁ¨¶ÔºåËØ∑‰ΩøÁî®Á∫ØËã±ÊñáÊï∞Â≠óÂíåÁ¨¶Âè∑', 'error');
            return;
          }

          const requestBody = this.getRequestBody();
          requestBody.stream = isStream;

          this.isLoading = true;
          this.isStreaming = isStream;
          this.audioSrc = '';
          this.showDownloadBtn = false; // ÈáçÁΩÆ‰∏ãËΩΩÊåâÈíÆÁä∂ÊÄÅ
          if (this.downloadUrl) {
            URL.revokeObjectURL(this.downloadUrl); // Ê∏ÖÁêÜ‰πãÂâçÁöÑ‰∏ãËΩΩÈìæÊé•
            this.downloadUrl = '';
          }
          this.updateStatus('Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...', 'info');

          try {
            if (isStream) {
              await this.playStreamWithMSE(baseUrl, apiKey, requestBody);
            } else {
              await this.playStandard(baseUrl, apiKey, requestBody);
            }
          } catch (error) {
            console.error('Error generating speech:', error);
            this.updateStatus('ÈîôËØØ: ' + error.message, 'error');
          } finally {
            this.isLoading = false;
            this.isStreaming = false;
          }
        },
        async playStandard(baseUrl, apiKey, body) {
          const response = await fetch(baseUrl + '/api/v1/audio/speech', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + apiKey,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
              'HTTP error! status: ' + response.status
            );
          }

          const blob = await response.blob();
          this.audioSrc = URL.createObjectURL(blob);
          this.downloadUrl = this.audioSrc; // ÈùûÊµÅÂºèÊ®°ÂºèÁõ¥Êé•‰ΩøÁî®Áõ∏ÂêåÁöÑURL
          this.showDownloadBtn = true;
          this.updateStatus('Êí≠Êîæ‰∏≠...', 'success');

          // Ëá™Âä®Êí≠Êîæ
          this.$nextTick(() => {
            this.$refs.audioPlayer.play().catch(e =>
              console.warn('Autoplay was prevented:', e)
            );
          });
        },
        async playStreamWithMSE(baseUrl, apiKey, body) {
          const mediaSource = new MediaSource();
          this.audioSrc = URL.createObjectURL(mediaSource);

          // Áî®‰∫éÊî∂ÈõÜÈü≥È¢ëÊï∞ÊçÆÁöÑÊï∞ÁªÑ
          const audioChunks = [];

          return new Promise((resolve, reject) => {
            mediaSource.addEventListener('sourceopen', async () => {
              URL.revokeObjectURL(this.audioSrc);
              const sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');

              try {
                const response = await fetch(baseUrl + '/api/v1/audio/speech', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + apiKey,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(body),
                });

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(
                    errorData.error?.message ||
                    'HTTP error! status: ' + response.status
                  );
                }

                this.updateStatus('Â∑≤ËøûÊé•ÔºåÊé•Êî∂Êï∞ÊçÆ‰∏≠...', 'info');

                // Ëá™Âä®Êí≠Êîæ
                this.$nextTick(() => {
                  this.$refs.audioPlayer.play().catch(e =>
                    console.warn('Autoplay was prevented:', e)
                  );
                });

                const reader = response.body.getReader();

                const pump = async () => {
                  const { done, value } = await reader.read();

                  if (done) {
                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                      mediaSource.endOfStream();
                    }

                    // ÂàõÂª∫ÂÆåÊï¥ÁöÑÈü≥È¢ëÊñá‰ª∂Áî®‰∫é‰∏ãËΩΩ
                    const completeAudioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    this.downloadUrl = URL.createObjectURL(completeAudioBlob);
                    this.showDownloadBtn = true;

                    this.updateStatus('Êí≠ÊîæÂÆåÊØïÔºÅÂèØÁÇπÂáª‰∏ãËΩΩÊåâÈíÆ‰øùÂ≠òÈü≥È¢ë', 'success');
                    resolve();
                    return;
                  }

                  // Êî∂ÈõÜÈü≥È¢ëÊï∞ÊçÆÂùó
                  audioChunks.push(value.slice()); // ‰ΩøÁî®slice()ÂàõÂª∫ÂâØÊú¨

                  if (sourceBuffer.updating) {
                    await new Promise(resolve =>
                      sourceBuffer.addEventListener('updateend', resolve, { once: true })
                    );
                  }

                  sourceBuffer.appendBuffer(value);
                  this.updateStatus('Ê≠£Âú®ÊµÅÂºèÊí≠Êîæ...', 'success');
                };

                sourceBuffer.addEventListener('updateend', pump);
                await pump();
              } catch (error) {
                console.error('Error in MSE streaming:', error);
                this.updateStatus('ÈîôËØØ: ' + error.message, 'error');
                if (mediaSource.readyState === 'open') {
                  try {
                    mediaSource.endOfStream();
                  } catch (e) { }
                }
                reject(error);
              }
            }, { once: true });
          });
        },
        onAudioLoadStart() {
          console.log('Audio loading started');
        },
        onAudioCanPlay() {
          console.log('Audio can play');
        },
        // ÊèíÂÖ•ÂÅúÈ°øÊ†áÁ≠æ
        insertPause() {
          const textarea = this.$refs.textareaRef;
          if (!textarea) return;
          if (!this.pauseTime || this.pauseTime <= 0 || this.pauseTime > 100) {
            window.alert('ÂÅúÈ°øÊó∂Èó¥ÂøÖÈ°ªÂú® 0.01 Âà∞ 100 Áßí‰πãÈó¥', 'error');
            return;
          }

          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const breakTag = '<break time="' + this.pauseTime + 's"/>';

          const newText = this.form.inputText.slice(0, start) +
            breakTag +
            this.form.inputText.slice(end);

          this.form.inputText = newText;

          // ‰øùÊåÅÂÖâÊ†á‰ΩçÁΩÆ
          this.$nextTick(() => {
            const newPos = start + breakTag.length;
            textarea.focus();
            textarea.setSelectionRange(newPos, newPos);
          });
        }
      },
      mounted() {
        this.loadConfig();
        this.loadForm();
      },
      beforeUnmount() {
        // Ê∏ÖÁêÜURLÂØπË±°ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÊºè
        if (this.audioSrc) {
          URL.revokeObjectURL(this.audioSrc);
        }
        if (this.downloadUrl && this.downloadUrl !== this.audioSrc) {
          URL.revokeObjectURL(this.downloadUrl);
        }
      }
    }).mount('#app');
  </script>
</body>

</html>
